<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body, html { height: 100%; width: 100%; overflow: hidden; }
        body { background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; }
        .container { display: flex; flex-direction: column; height: 100vh; background: white; }
        .header { background: #0084ff; color: white; padding: 15px; text-align: center; }
        .header h1 { font-size: 1.5em; }
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; }
        .message { 
            max-width: 80%; 
            padding: 12px 16px; 
            margin-bottom: 12px; 
            border-radius: 18px; 
            background: #e4e6eb; 
            color: #050505;
            position: relative;
            word-wrap: break-word;
        }
        .message-time { font-size: 0.7em; color: #666; margin-top: 5px; }
        .message-actions { display: none; }
        .admin-active .message-actions { 
            display: block; 
            position: absolute; 
            top: 8px; 
            right: 10px; 
        }
        .action-btn { 
            background: #0084ff; 
            color: white; 
            border: none; 
            padding: 3px 8px; 
            margin-left: 5px; 
            border-radius: 4px; 
            font-size: 0.8em; 
            cursor: pointer; 
        }
        .input-area { padding: 15px; background: #f8f9fa; border-top: 1px solid #ddd; display: flex; }
        #message-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; }
        #send-button { padding: 12px 20px; background: #0084ff; color: white; border: none; border-radius: 20px; margin-left: 10px; }
        .empty-state { text-align: center; color: #666; padding: 40px 20px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header"><h1>留言板</h1></div>
        <div class="chat-container" id="chat-box">
            <div class="empty-state" id="empty-state">暂无消息</div>
        </div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="输入消息...">
            <button id="send-button">发送</button>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDJEgkdLHpjKdyngP5XuY_AJGUc5mOjeCg",
            authDomain: "public-chat-board.firebaseapp.com",
            databaseURL: "https://public-chat-board-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "public-chat-board",
            storageBucket: "public-chat-board.firebasestorage.app",
            messagingSenderId: "822856065923",
            appId: "1:822856065923:web:833a3f1a6a4fc4840e8cb6"
        };

        // 初始化
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 页面元素
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const emptyState = document.getElementById('empty-state');

        // 状态
        let adminMode = false;
        let editingMessageId = null;

        // 发送消息
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            // 检查是否为"修改"关键词
            if (text === "修改") {
                adminMode = true;
                updateMessagesDisplay();
                messageInput.value = "";
                return;
            }

            // 普通消息，存入数据库
            database.ref('messages/').push({
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            messageInput.value = "";
        }

        // 格式化时间
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        // 更新消息显示
        function updateMessagesDisplay() {
            database.ref('messages/').once('value', (snapshot) => {
                const data = snapshot.val();
                chatBox.innerHTML = '';

                if (!data) {
                    emptyState.style.display = 'block';
                    chatBox.appendChild(emptyState);
                    return;
                }

                emptyState.style.display = 'none';
                const messages = Object.entries(data).map(([id, msg]) => ({ id, ...msg }));
                messages.sort((a, b) => a.timestamp - b.timestamp);

                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = adminMode ? 'message admin-active' : 'message';
                    div.dataset.id = msg.id;

                    const timeStr = formatTime(msg.timestamp);
                    const escapedText = msg.text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    
                    let actionsHtml = '';
                    if (adminMode) {
                        actionsHtml = `
                            <div class="message-actions">
                                <button class="action-btn" onclick="editMessage('${msg.id}')">修改</button>
                                <button class="action-btn" onclick="deleteMessage('${msg.id}')">删除</button>
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        <div>${escapedText}</div>
                        <div class="message-time">${timeStr}</div>
                        ${actionsHtml}
                    `;
                    
                    chatBox.appendChild(div);
                });
            });
        }

        // 编辑消息
        function editMessage(id) {
            editingMessageId = id;
            database.ref('messages/' + id).once('value', (snapshot) => {
                const msg = snapshot.val();
                const newText = prompt('修改消息:', msg.text);
                if (newText !== null && newText.trim() !== '') {
                    database.ref('messages/' + id).update({
                        text: newText.trim(),
                        edited: true,
                        editedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        }

        // 删除消息
        function deleteMessage(id) {
            if (confirm('确定删除这条消息吗？')) {
                database.ref('messages/' + id).remove();
            }
        }

        // 事件监听
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // 实时监听消息变化
        database.ref('messages/').on('value', updateMessagesDisplay);

        // 页面加载
        window.addEventListener('load', () => {
            messageInput.focus();
            updateMessagesDisplay();
        });
    </script>
</body>
</html>
